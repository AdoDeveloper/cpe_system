<div class="container p-4">
  <div class="row justify-content-center">
    <h1 class="text-center mb-4">Modificar Rol</h1>
  </div>

  <div class="row justify-content-center">
    <div class="col-md-8">
      
      {{!-- Mostrar errores si existen --}}
      {{#if errors}}
        <div class="alert alert-danger">
          <ul>
            {{#each errors}}
              <li>{{this.msg}}</li>
            {{/each}}
          </ul>
        </div>
      {{/if}}

      {{!-- Formulario para modificar rol --}}
      <form method="POST" action="/roles/edit/{{rol.id}}?_method=PUT" id="rolForm">
        
        <div class="form-group">
          <input type="text" class="form-control" name="nombre" placeholder="Nombre del Rol" value="{{rol.nombre}}" required autofocus>
        </div>

        {{!-- Permisos --}}
        <div class="form-group">
          <label>Permisos</label>
          <div id="permisosRutas" class="border p-3 bg-light">
            {{#each permisos}}
              <div class="permisoRuta mb-3 border p-3 bg-white" id="permiso-{{@index}}">
                <div class="form-group">
                  <label>Ruta</label>
                  <input type="text" class="form-control" name="permisos[{{@index}}][ruta]" value="{{this.ruta}}" placeholder="/ruta" required>
                </div>

                <div class="form-group">
                  <label>Descripción del Permiso</label>
                  <input type="text" class="form-control" name="permisos[{{@index}}][descripcion]" value="{{this.descripcion}}" placeholder="Descripción del permiso" required>
                </div>

                <div class="form-group">
                  <label>Método HTTP</label>
                  <select class="form-control" name="permisos[{{@index}}][metodo]" required>
                    <option value="GET" {{#if (eq this.metodo 'GET')}}selected{{/if}}>GET</option>
                    <option value="POST" {{#if (eq this.metodo 'POST')}}selected{{/if}}>POST</option>
                    <option value="PUT" {{#if (eq this.metodo 'PUT')}}selected{{/if}}>PUT</option>
                    <option value="DELETE" {{#if (eq this.metodo 'DELETE')}}selected{{/if}}>DELETE</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Tipo de Permiso</label>
                  <select class="form-control" name="permisos[{{@index}}][tipo]" required>
                    <option value="lectura" {{#if (eq this.tipo 'lectura')}}selected{{/if}}>Lectura</option>
                    <option value="escritura" {{#if (eq this.tipo 'escritura')}}selected{{/if}}>Escritura</option>
                    <option value="eliminación" {{#if (eq this.tipo 'eliminación')}}selected{{/if}}>Eliminación</option>
                  </select>
                </div>

                <div class="form-group mt-2">
                  <label>Módulo (opcional)</label>
                  <select class="form-control" name="permisos[{{@index}}][moduloId]">
                    <option value="">Sin módulo</option>
                    {{#each ../modulosDisponibles}}
                      <option value="{{this.id}}" {{#if (eq this.id ../this.moduloId)}}selected{{/if}}>{{this.nombre}}</option>
                    {{/each}}
                  </select>
                </div>
                <!-- Botón de eliminar ruta -->
                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarPermiso({{@index}})">Eliminar Ruta</button>
              </div>
            {{/each}}
          </div>
          <button type="button" class="btn btn-info mt-2" onclick="agregarPermiso()">Agregar Ruta</button>
        </div>

        <div class="form-group text-center mt-4">
          <button class="btn btn-primary" type="submit">Guardar Cambios</button>
          <a href="/roles" class="btn btn-secondary ml-2">Cancelar</a> <!-- Botón para cancelar -->
        </div>

      </form>

    </div>
  </div>
</div>

<script>
  // Función para agregar dinámicamente más permisos
  function agregarPermiso() {
    const index = document.querySelectorAll('.permisoRuta').length;
    const newPermiso = `
      <div class="permisoRuta mt-3 border p-3 bg-light" id="permiso-${index}">
        <div class="form-group">
          <label>Ruta</label>
          <input type="text" class="form-control" name="permisos[${index}][ruta]" placeholder="/ruta" required>
        </div>

        <div class="form-group">
          <label>Descripción del Permiso</label>
          <input type="text" class="form-control" name="permisos[${index}][descripcion]" placeholder="Descripción del permiso" required>
        </div>

        <div class="form-group">
          <label>Método HTTP</label>
          <select class="form-control" name="permisos[${index}][metodo]" required>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
          </select>
        </div>

        <div class="form-group">
          <label>Tipo de Permiso</label>
          <select class="form-control" name="permisos[${index}][tipo]" required>
            <option value="lectura">Lectura</option>
            <option value="escritura">Escritura</option>
            <option value="eliminación">Eliminación</option>
          </select>
        </div>

        <div class="form-group mt-2">
          <label>Módulo (opcional)</label>
          <select class="form-control" name="permisos[${index}][moduloId]">
            <option value="">Sin módulo</option>
            {{#each modulosDisponibles}}
              <option value="{{this.id}}">{{this.nombre}}</option>
            {{/each}}
          </select>
        </div>
        <!-- Botón de eliminar ruta -->
        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarPermiso(${index})">Eliminar Ruta</button>
      </div>
    `;
    document.getElementById('permisosRutas').insertAdjacentHTML('beforeend', newPermiso);
  }

  // Función para eliminar un permiso
  function eliminarPermiso(index) {
    const permisoElement = document.getElementById(`permiso-${index}`);
    permisoElement.remove();
  }

  // Mostrar SweetAlert2 spinner al enviar el formulario
  document.getElementById('rolForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevenir el envío automático

    // Mostrar spinner con SweetAlert2
    Swal.fire({
      title: 'Guardando cambios...',
      text: 'Por favor, espera mientras se procesan los cambios.',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // Enviar el formulario después de mostrar el spinner
    this.submit();
  });
</script>
