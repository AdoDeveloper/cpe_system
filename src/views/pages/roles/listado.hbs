<div class="container-fluid p-4">
  <div class="row">
    <div class="col-12 col-md-6">
      <h3 class="mb-3">Listado de Roles</h3>
    </div>
    <div class="col-12 col-md-6 text-md-right text-center">
      <a href="/roles/new" class="btn btn-success mb-2">
        <i class="fas fa-plus"></i> Agregar Rol
      </a>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">Roles y Permisos</h4>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered table-hover table-striped">
              <thead class="thead-light">
                <tr>
                  <th style="width: 10%">No. Rol</th>
                  <th style="width: 20%">NOMBRE</th>
                  <th style="width: 30%">PERMISOS</th>
                  <th style="width: 20%">MODULOS ASIGNADOS</th>
                  <th style="width: 20%">ACCIONES</th>
                </tr>
              </thead>
              <tbody>
                {{#each roles}}
                <tr>
                  <td>{{id}}</td>
                  <td>{{nombre}}</td>
                  <td>
                    {{#each permisos}}
                    <strong>{{this.ruta}}</strong> ({{this.metodo}}) - {{this.descripcion}} <br>
                    <small>Tipo:
                      {{#if (eq this.tipo 'lectura')}}
                      <span class="badge badge-primary">Lectura</span>
                      {{else if (eq this.tipo 'escritura')}}
                      <span class="badge badge-warning">Escritura</span>
                      {{else if (eq this.tipo 'eliminación')}}
                      <span class="badge badge-danger">Eliminación</span>
                      {{/if}}
                    </small>
                    <hr class="my-1">
                    {{else}}
                    <span class="text-muted">No hay permisos asignados</span>
                    {{/each}}
                  </td>
                  <td>
                    {{#if modulos.length}}
                    {{#each modulos}}
                    <span class="badge badge-info">{{this}}</span><br>
                    {{/each}}
                    {{else}}
                    <span class="text-muted">No hay módulos asignados</span>
                    {{/if}}
                  </td>
                  <td class="text-center">
                    <a href="/roles/edit/{{id}}" class="btn btn-primary btn-sm mr-1" title="Modificar">
                      <i class="fas fa-edit"></i>
                    </a>

                    {{!-- Si el rol es de administrador y solo hay un administrador, mostrar una alerta al hacer clic --}}
                    {{#if (and esAdmin ../soloUnAdmin)}}
                    <button class="btn btn-danger btn-sm" title="No se puede eliminar el último administrador"
                      onclick="alertaUltimoAdmin()">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                    {{else}}
                    <form id="deleteForm-{{id}}" method="POST" action="/roles/delete/{{id}}?_method=DELETE"
                      style="display:inline;" onsubmit="return confirmDeleteRol(event, '{{id}}', '{{nombre}}')">
                      <button type="submit" class="btn btn-danger btn-sm" title="Eliminar">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </form>
                    {{/if}}
                  </td>
                </tr>
                {{/each}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/plugins/sweetalert2/sweetalert2.all.min.js"></script>
<script>
  function confirmDeleteRol(event, id, nombreRol) {
    event.preventDefault(); // Evitar el envío del formulario inmediatamente
    Swal.fire({
      title: '¿Estás seguro?',
      text: `Estás a punto de eliminar el rol: ${nombreRol}. Esta acción no se puede deshacer.`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        document.getElementById(`deleteForm-${id}`).submit();
      }
    });
  }

  // Alerta cuando se intenta eliminar el último administrador
  function alertaUltimoAdmin() {
    Swal.fire({
      title: 'Acción no permitida',
      text: 'No puedes eliminar el último rol de administrador, ya que perderías el acceso al sistema.',
      icon: 'error',
      confirmButtonColor: '#3085d6',
      confirmButtonText: 'Entendido'
    });
  }
</script>
